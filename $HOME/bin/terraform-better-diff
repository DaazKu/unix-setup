#!/usr/bin/env python3 -u
import argparse
import re
import subprocess
import sys
import tempfile

"""
- Highlight EOL terminating with spaces for lines that differ
- Some providers will shoot you massive EOT blocks with no clear highlights of what changed. This tool will replace that with a better diff section.
"""

parser = argparse.ArgumentParser(
    description="Better diff for some aspect of Terraform plans. Reads from STDIN.",
    formatter_class=argparse.ArgumentDefaultsHelpFormatter
)
parser.add_argument(
    "--color",
    action="store",
    choices=["never", "always", "auto"],
    default="auto",
    help="color output",
)
parser.add_argument(
    "--diff-path",
    action="store",
    default="diff",
    help="path to the diff command. Relies on the shell's PATH by default.",
)
args = parser.parse_args()
config = vars(args)

color_output = sys.stdout.isatty() if config['color'] == 'auto' else config['color']

v1 = []
v2 = []
capture_begin = ''
capturing = False
capture_target = "v1"

def rspace_highlighter(content: str) -> str:
    return re.sub("^( *)(\\u001B\\[3[12]m)?(-|\\+)(\\u001B\\[0m\\u001B\\[0m)?( .*?)( +)$", "\\1\\2\\3\\4\\5\\6$ <- RSpcEnd", content)

def reset():
    global v1,v2,capture_begin,capturing,capture_target
    v1 = []
    v2 = []
    capturing = False
    capture_begin = ''
    capture_target = "v1"

for line in sys.stdin:
    if re.search(".*-.*<<-?EOT\n", line):
        capturing = True
        capture_begin = line

        # This is not an EOT diff. We're supposed to have a + following up
        # So we flush everything and restart!
        if len(v1) and re.search(".*-.*<<-?EOT\n", line):
            print(rspace_highlighter(capture_begin), end='')
            print(rspace_highlighter("".join(v1)), end='')
            print(rspace_highlighter(line), end='')
            reset()

        continue

    if capturing == False:
        if re.search(".*\\+.*<<-?EOT\n", line):
            capturing = True
            capture_target = "v2"
        else:
            print(rspace_highlighter(line), end='')

        continue

    if re.search("EOT,?\n", line):
        capturing = False

        if len(v1) and len(v2):
            with tempfile.NamedTemporaryFile(mode='w+', encoding='utf-8') as v1_file_handler:
                v1_file_handler.writelines(v1)
                v1_file_handler.flush()
                v1_file_name = v1_file_handler.name

                with tempfile.NamedTemporaryFile(mode='w+', encoding='utf-8') as v2_file_handler:
                    result = v2_file_handler.writelines(v2)
                    v2_file_handler.flush()
                    v2_file_name = v2_file_handler.name

                    diff_command = f"{config['diff_path']} --color={'always' if color_output else 'never'} -u {v1_file_name} {v2_file_name}"

                    process = subprocess.run(
                        diff_command,
                        stdout=subprocess.PIPE,
                        stderr=subprocess.STDOUT,
                        shell=True,
                    )

                    print(">>>>>> Generated by terraform-better-diff")
                    print(rspace_highlighter("\n".join(process.stdout.decode('utf-8').split("\n")[2:-1])))
                    print("<<<<<< terraform-better-diff END")

            reset()

        continue

    if capture_target == "v1":
        v1.append(line)
    else:
        v2.append(line)
    continue
